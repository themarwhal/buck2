"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9667],{3905:(e,t,n)=>{n.r(t),n.d(t,{MDXContext:()=>d,MDXProvider:()=>u,mdx:()=>b,useMDXComponents:()=>c,withMDXComponents:()=>p});var o=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(){return a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},a.apply(this,arguments)}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var d=o.createContext({}),p=function(e){return function(t){var n=c(t.components);return o.createElement(e,a({},t,{components:n}))}},c=function(e){var t=o.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return o.createElement(d.Provider,{value:t},e.children)},m="mdxType",f={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=c(n),u=r,m=p["".concat(l,".").concat(u)]||p[u]||f[u]||a;return n?o.createElement(m,i(i({ref:t},d),{},{components:n})):o.createElement(m,i({ref:t},d))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=h;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[m]="string"==typeof e?e:r,l[1]=i;for(var d=2;d<a;d++)l[d]=n[d];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},24509:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>c,frontMatter:()=>a,metadata:()=>i,toc:()=>d});var o=n(87462),r=(n(67294),n(3905));const a={id:"vpnless",title:"Migrating to VPNless builds"},l=void 0,i={unversionedId:"users/advanced/vpnless",id:"users/advanced/vpnless",title:"Migrating to VPNless builds",description:"Along with the wider VPNless effort to enable full development on corporate laptops/desktops sans VPN, buck2 has been updated to work completely without VPN access.",source:"@site/../docs/users/advanced/vpnless.md",sourceDirName:"users/advanced",slug:"/users/advanced/vpnless",permalink:"/docs/users/advanced/vpnless",draft:!1,tags:[],version:"current",frontMatter:{id:"vpnless",title:"Migrating to VPNless builds"}},s={},d=[{value:"Migration guide",id:"migration-guide",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"I just need to build!",id:"i-just-need-to-build",level:3},{value:"Errors you may see",id:"errors-you-may-see",level:3},{value:"Everstore contents",id:"everstore-contents",level:3},{value:"Manifold contents",id:"manifold-contents",level:3},{value:"Everything else",id:"everything-else",level:3}],p={toc:d};function c(e){let{components:t,...n}=e;return(0,r.mdx)("wrapper",(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.mdx)("p",null,"Along with the wider ",(0,r.mdx)("a",{parentName:"p",href:"https://fb.workplace.com/groups/1415703449254519"},"VPNless effort")," to enable full development on corporate laptops/desktops sans VPN, buck2 has been updated to work completely without VPN access."),(0,r.mdx)("blockquote",null,(0,r.mdx)("p",{parentName:"blockquote"},"NOTE: VPNless operation is ",(0,r.mdx)("em",{parentName:"p"},"only")," supported for buck2; buck1 will not work vpnless.")),(0,r.mdx)("h2",{id:"migration-guide"},"Migration guide"),(0,r.mdx)("p",null,"To migrate your build to work VPNless, you'll need to do a few things:"),(0,r.mdx)("ol",null,(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("p",{parentName:"li"},"Join ",(0,r.mdx)("a",{parentName:"p",href:"https://fb.workplace.com/groups/1415703449254519"},"VPNless Local Dev Testers")," so you get enrolled in all the relevant GKs to enable VPNless.")),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("p",{parentName:"li"},"Wait a bit for permissions to propagate. You may try running chef on your laptop with ",(0,r.mdx)("inlineCode",{parentName:"p"},"sudo soloctl -i")," to speed things up after joining the group.")),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("p",{parentName:"li"},"Drop off VPN (or lighthouse); verify you're connected to your non-corporate network.")),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("p",{parentName:"li"},"Restart buck2 on your laptop so you pick up the new configuration:"))),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-[bash]"},"$ buck2 kill\n")),(0,r.mdx)("ol",{start:5},(0,r.mdx)("li",{parentName:"ol"},"Run your build, verify it works. Congratulations, you're building VPNless \ud83d\ude0e")),(0,r.mdx)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,r.mdx)("p",null,"Many builds should Just Work without VPN / lighthouse, but sometimes certain build rules need to be updated."),(0,r.mdx)("h3",{id:"i-just-need-to-build"},"I just need to build!"),(0,r.mdx)("p",null,"If you're running into a hard blocker and need to do a build even while gated into VPNless development, simply hop back onto VPN/Lighthouse and re-run your build. You may need to run ",(0,r.mdx)("inlineCode",{parentName:"p"},"buck2 clean")," in order to get to a working state again."),(0,r.mdx)("h3",{id:"errors-you-may-see"},"Errors you may see"),(0,r.mdx)("p",null,"You may see failures like the following when performing a VPNless build the first time:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"$ buck2 build //my/cool:project\nAction failed: fbsource//xplat/toolchains/apple:xcode_14.3.1_14e300b-macosx-sdk_genrule (download_file archive.tar.zst)\nInternal error: Received invalid sha1 digest. Expected eaaf6bd1951ee7200ca66d608dc837e28883ec1e, got bcac2ddc59677d169098742206a7c110fa00a385 from https://our.intern.facebook.com/intern/managed_sdk/component/272435095345806/; perhaps this url is not gated into vpnless?\nAction failed: fbsource//xplat/toolchains/apple:xcode_14.3.1_14e300b_swift-resource-dir_macos (download_file archive.tar.zst)\nInternal error: Received invalid sha1 digest. Expected f7cc25942c4e8a56f87c851ad75e351e71fae49a, got e63063370b23229764fa0d61e8fc6bbfe7137c16 from https://our.intern.facebook.com/intern/managed_sdk/component/271406345550923/; perhaps this url is not gated into vpnless?\nAction failed: fbsource//xplat/toolchains/apple:xcode_14.3.1_14e300b_macosx-swift-resource-dir_macos (download_file archive.tar.zst)\nInternal error: Received invalid sha1 digest. Expected b6bd2a7faba6985ccd2dd541efdeb48dfb82da31, got 93c6003bc10513445a20ec89d0843419192bd02d from https://our.intern.facebook.com/intern/managed_sdk/component/259997920045153/; perhaps this url is not gated into vpnless?\nAction failed: fbsource//xplat/toolchains/apple:xcode_14.3.1_14e300b_linker-resource-dir_macos (download_file archive.tar.zst)\nInternal error: Received invalid sha1 digest. Expected 145cde8a2d9c65f2bdd66818970b94c9ae974b3f, got 395b70b84a5e3ee8a12bed3cd0c31968fb37b94b from https://our.intern.facebook.com/intern/managed_sdk/component/786106529582223/; perhaps this url is not gated into vpnless?\nAction failed: fbsource//xplat/toolchains/apple:xcode_14.3.1_14e300b_clang-resource-dir_macos (download_file archive.tar.zst)\nInternal error: Received invalid sha1 digest. Expected f32f8356ed50596d5c000018573e9fd5d2836e48, got c4346966bd9c976f44e951f7e3974e8d2d0f3e86 from https://our.intern.facebook.com/intern/managed_sdk/component/921533932454562/; perhaps this url is not gated into vpnless?\nBUILD FAILED\n")),(0,r.mdx)("p",null,"The ",(0,r.mdx)("inlineCode",{parentName:"p"},'"perhaps this url is not gated into vpnless?"')," should clue you in that this URL is unauthorized for VPNless."),(0,r.mdx)("p",null,"You may also see errors like:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"$ buck2 build //my/cool:project\nAction failed: fbcode//third-party-java/commons-logging:commons-logging__1.2.jar (download_file commons-logging__1.2.jar)\nInternal error: Error performing http_head request: HTTP: Error routing through x2p: Failed to connect to `manifold.facebook.net`; is it allowed on vpnless?\nBuck UI: https://www.internalfb.com/buck2/fb694d27-b52d-4349-97f5-8082b24ec8f8\nNote:    Using experimental modern dice\nNetwork: Up: 280KiB  Down: 2.9MiB  (reSessionID-dab2bfcd-8b67-445a-b68f-0283619cc5da)\nJobs completed: 5739. Time elapsed: 20.3s.\nCache hits: 99%. Commands: 729 (cached: 725, remote: 2, local: 2)\nBUILD FAILED\n")),(0,r.mdx)("p",null,"Again, ",(0,r.mdx)("inlineCode",{parentName:"p"},'"is it allowed on vpnless?"')," indicates this is likely a VPNless URL problem."),(0,r.mdx)("p",null,"The most common issue we've seen is using a URL or endpoint that's not allowlisted for VPN access. This includes common endpoints like ",(0,r.mdx)("inlineCode",{parentName:"p"},"our.intern.facebook.com"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"interngraph.intern.facebook.com"),", or ",(0,r.mdx)("inlineCode",{parentName:"p"},"manifold.facebook.net"),"."),(0,r.mdx)("p",null,"The majority of broken rules will be something like ",(0,r.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/code/fbsource/fbcode/buck2/prelude/remote_file.bzl"},(0,r.mdx)("inlineCode",{parentName:"a"},"remote_file"))," or ",(0,r.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/code/fbsource/fbcode/buck2/prelude/http_archive/http_archive.bzl"},(0,r.mdx)("inlineCode",{parentName:"a"},"http_archive"))," rules which download from one of these three host. Instead, we have a slightly different way to tell buck which URL to use."),(0,r.mdx)("h3",{id:"everstore-contents"},"Everstore contents"),(0,r.mdx)("p",null,"Many builds download remote Everstore artifacts via custom intern-hosted endpoints. ",(0,r.mdx)("a",{parentName:"p",href:"https://fb.workplace.com/groups/1415703449254519/posts/1463410231150507"},"Android screenshot test fixtures")," are a good example. They have a ",(0,r.mdx)("inlineCode",{parentName:"p"},"remote_file")," call that looks like:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-[python]"},'fb_native.remote_file(\n    name = t.file_target.target_name,\n    out = t.file_target.output_name,\n    sha1 = t.file_target.sha1,\n    url = "https://our.intern.facebook.com/intern/screenshot_tests/resource/" + t.file_target.handle,\n)\n')),(0,r.mdx)("p",null,"The ",(0,r.mdx)("inlineCode",{parentName:"p"},"our.intern.facebook.com")," URL is not authorized for VPNless access. Instead, you'll need to provide a new ",(0,r.mdx)("inlineCode",{parentName:"p"},"vpnless_url")," attribute."),(0,r.mdx)("p",null,"Most ",(0,r.mdx)("inlineCode",{parentName:"p"},"remote_file")," calls like this have an associated Everstore handle (that looks something like ",(0,r.mdx)("inlineCode",{parentName:"p"},"GPN0ZxTT3RXSQqkAAOhsHRepy5dGbjRYAA"),"). Assuming you have this handle, you can use our ",(0,r.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/code/fbsource/tools/build_defs/buck2/vpnless.bzl"},"VPNless helper macro library")," to make migration easier:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-[python]"},'load("fbsource//tools/build_defs/buck2:vpnless.bzl", "vpnless")\n\nfb_native.remote_file(\n    name = t.file_target.target_name,\n    out = t.file_target.output_name,\n    sha1 = t.file_target.sha1,\n    url = "https://our.intern.facebook.com/intern/screenshot_tests/resource/" + t.file_target.handle,\n+   vpnless_url = vpnless.everstore_url(t.file_target.handle),\n)\n')),(0,r.mdx)("p",null,"Once you update your broken targets, try rebuilding and see if that works."),(0,r.mdx)("h3",{id:"manifold-contents"},"Manifold contents"),(0,r.mdx)("p",null,"Manifold is very similar. If you have a ",(0,r.mdx)("inlineCode",{parentName:"p"},"remote_file")," rule referencing Manifold paths, consider switching to ",(0,r.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/code/fbsource/tools/build_defs/manifold.bzl"},(0,r.mdx)("inlineCode",{parentName:"a"},"manifold_get")," from the build_defs Manifold macros")," which has already been updated to provide the ",(0,r.mdx)("inlineCode",{parentName:"p"},"vpnless_url")," attribute."),(0,r.mdx)("h3",{id:"everything-else"},"Everything else"),(0,r.mdx)("p",null,"Some other things we've seen break are:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"MSDK bumps that rely on generated ",(0,r.mdx)("inlineCode",{parentName:"li"},".bzl")," files in the repo. The code generator has been updated to add the ",(0,r.mdx)("inlineCode",{parentName:"li"},"vpnless_url")," attribute, you simply need to run a bump of your MSDK entry.")),(0,r.mdx)("p",null,"For any other questions or concerns about builds on VPNless, please post in ",(0,r.mdx)("a",{parentName:"p",href:"https://fb.workplace.com/groups/1415703449254519"},"VPNless Local Dev Testers"),"."))}c.isMDXComponent=!0}}]);